//
//  DevelopmentMenuView.swift
//  BulbsHUE
//
//  Created by Anton Reasin on 15.08.2025.
//

import SwiftUI

/// Development menu –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
struct DevelopmentMenuView: View {
    @EnvironmentObject private var navigationManager: NavigationManager
    @EnvironmentObject private var migrationAdapter: MigrationAdapter
    @EnvironmentObject private var appViewModel: AppViewModel
    
    @State private var diagnosticResult: String = ""
    @State private var showDiagnosticSheet = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    headerSection
                    
                    // Migration Section
                    migrationSection
                    
                    // Test Views Section
                    testViewsSection
                    
                    // Diagnostics Section
                    diagnosticsSection
                    
                    // Debug Information
                    debugInfoSection
                }
                .padding()
            }
            .navigationTitle("Development")
            .navigationBarTitleDisplayMode(.large)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("–ó–∞–∫—Ä—ã—Ç—å") {
                        navigationManager.go(.environment)
                    }
                }
            }
        }
    }
    
    private var headerSection: some View {
        VStack(spacing: 8) {
            Image(systemName: "hammer.fill")
                .font(.largeTitle)
                .foregroundColor(.blue)
            
            Text("Development Tools")
                .font(.title2)
                .fontWeight(.semibold)
            
            Text("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏")
                .font(.caption)
                .foregroundColor(.secondary)
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
    
    private var migrationSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Label("Clean Architecture Migration", systemImage: "arrow.triangle.2.circlepath")
                .font(.headline)
                .foregroundColor(.blue)
            
            Text("–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Clean Architecture + Redux")
                .font(.caption)
                .foregroundColor(.secondary)
            
            Button(action: {
                navigationManager.go(.migrationDashboard)
            }) {
                HStack {
                    Image(systemName: "chart.line.uptrend.xyaxis")
                    Text("Migration Dashboard")
                    Spacer()
                    Image(systemName: "chevron.right")
                        .foregroundColor(.secondary)
                }
                .padding()
                .background(Color.blue.opacity(0.1))
                .foregroundColor(.blue)
                .cornerRadius(8)
            }
            
            // Feature Flags Status
            VStack(alignment: .leading, spacing: 4) {
                Text("Current Feature Flags:")
                    .font(.subheadline)
                    .fontWeight(.medium)
                
                FeatureFlagStatusRow(
                    title: "Bridge Architecture",
                    isEnabled: MigrationFeatureFlags.useNewBridgeArchitecture
                )
                
                FeatureFlagStatusRow(
                    title: "Redux Lights",
                    isEnabled: MigrationFeatureFlags.useReduxForLights
                )
                
                FeatureFlagStatusRow(
                    title: "Debug Mode",
                    isEnabled: MigrationFeatureFlags.debugMigration
                )
            }
            .padding(.top, 8)
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
    
    private var testViewsSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Label("Test Views", systemImage: "testtube.2")
                .font(.headline)
                .foregroundColor(.orange)
            
            LazyVGrid(columns: [
                GridItem(.flexible()),
                GridItem(.flexible())
            ], spacing: 12) {
                TestViewButton(
                    title: "Bridge Discovery",
                    icon: "wifi.router",
                    action: { /* TODO: Navigate to BridgeDiscoveryTestView */ }
                )
                
                TestViewButton(
                    title: "Onboarding",
                    icon: "person.badge.plus",
                    action: { /* TODO: Navigate to OnboardingTestView */ }
                )
                
                TestViewButton(
                    title: "Smart Discovery",
                    icon: "magnifyingglass.circle",
                    action: { /* TODO: Navigate to SmartDiscoveryTestView */ }
                )
                
                TestViewButton(
                    title: "Figma Preview",
                    icon: "photo.artframe",
                    action: { /* TODO: Navigate to FigmaPreview */ }
                )
            }
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
    
    private var diagnosticsSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞")
                .font(.headline)
                .padding(.horizontal)
            
            // –ö–Ω–æ–ø–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –ª–∞–º–ø
            Button(action: {
                runLightSearchDiagnostics()
            }) {
                HStack {
                    Image(systemName: "magnifyingglass.circle.fill")
                        .font(.title2)
                        .foregroundColor(.blue)
                    
                    VStack(alignment: .leading, spacing: 4) {
                        Text("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ª–∞–º–ø")
                            .font(.callout)
                            .fontWeight(.medium)
                        Text("–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    Spacer()
                    
                    Image(systemName: "chevron.right")
                        .foregroundColor(.secondary)
                }
                .padding()
                .background(Color(.systemGray6))
                .cornerRadius(10)
            }
            .buttonStyle(PlainButtonStyle())
            
            // –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
            Button(action: {
                testNetworkSearch()
            }) {
                HStack {
                    Image(systemName: "speedometer")
                        .font(.title2)
                        .foregroundColor(.orange)
                    
                    VStack(alignment: .leading, spacing: 4) {
                        Text("–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –ø–æ–∏—Å–∫–∞")
                            .font(.callout)
                            .fontWeight(.medium)
                        Text("–¢–µ—Å—Ç network search —Å –ª–æ–≥–∞–º–∏")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    Spacer()
                    
                    Image(systemName: "chevron.right")
                        .foregroundColor(.secondary)
                }
                .padding()
                .background(Color(.systemGray6))
                .cornerRadius(10)
            }
            .buttonStyle(PlainButtonStyle())
        }
        .padding(.horizontal)
        .sheet(isPresented: $showDiagnosticSheet) {
            DiagnosticResultView(result: diagnosticResult)
        }
    }
    
    private var debugInfoSection: some View {
        VStack(alignment: .leading, spacing: 8) {
            Label("Debug Information", systemImage: "info.circle")
                .font(.headline)
                .foregroundColor(.green)
            
            VStack(alignment: .leading, spacing: 4) {
                Text("Redux Store: ‚úÖ Initialized")
                Text("Migration Adapter: ‚úÖ Ready")
                Text("Navigation Manager: ‚úÖ Active")
                
                if MigrationFeatureFlags.debugMigration {
                    Text("Debug Mode: ‚úÖ Enabled")
                        .foregroundColor(.blue)
                } else {
                    Text("Debug Mode: ‚ùå Disabled")
                        .foregroundColor(.secondary)
                }
            }
            .font(.caption)
            .padding(.top, 4)
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
    
    // MARK: - Diagnostic Methods
    
    private func runLightSearchDiagnostics() {
        appViewModel.lightsViewModel.runSearchDiagnostics { result in
            self.diagnosticResult = result
            self.showDiagnosticSheet = true
        }
    }
    
    private func testNetworkSearch() {
        appViewModel.lightsViewModel.testNetworkSearchWithLogs { success, log in
            self.diagnosticResult = log
            self.showDiagnosticSheet = true
        }
    }
}

struct FeatureFlagStatusRow: View {
    let title: String
    let isEnabled: Bool
    
    var body: some View {
        HStack {
            Text("‚Ä¢ \(title)")
                .font(.caption)
            Spacer()
            Text(isEnabled ? "ON" : "OFF")
                .font(.caption)
                .fontWeight(.semibold)
                .foregroundColor(isEnabled ? .green : .red)
        }
    }
}

// MARK: - Diagnostic Result View

struct DiagnosticResultView: View {
    let result: String
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(alignment: .leading, spacing: 12) {
                    Text(result)
                        .font(.system(.body, design: .monospaced))
                        .padding()
                }
            }
            .navigationTitle("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("–ì–æ—Ç–æ–≤–æ") {
                        dismiss()
                    }
                }
                
                ToolbarItem(placement: .navigationBarLeading) {
                    Button(action: {
                        UIPasteboard.general.string = result
                    }) {
                        Label("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", systemImage: "doc.on.doc")
                    }
                }
            }
        }
    }
}

struct TestViewButton: View {
    let title: String
    let icon: String
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            VStack(spacing: 8) {
                Image(systemName: icon)
                    .font(.title2)
                    .foregroundColor(.orange)
                
                Text(title)
                    .font(.caption)
                    .multilineTextAlignment(.center)
                    .foregroundColor(.primary)
            }
            .frame(maxWidth: .infinity, minHeight: 80)
            .background(Color.orange.opacity(0.1))
            .cornerRadius(8)
        }
    }
}

#if DEBUG
struct DevelopmentMenuView_Previews: PreviewProvider {
    static var previews: some View {
        DevelopmentMenuView()
            .environmentObject(NavigationManager.shared)
            .environmentObject(MigrationAdapter(
                store: AppStore(),
                appViewModel: AppViewModel()
            ))
    }
}
#endif
