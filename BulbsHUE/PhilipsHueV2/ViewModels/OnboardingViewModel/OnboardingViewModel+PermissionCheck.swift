//
//  OnboardingViewModel+PermissionCheck.swift
//  BulbsHUE
//
//  Created by Anton Reasin on 8/16/25.
//

import SwiftUI

extension OnboardingViewModel {
    
    // MARK: - Permission Check Connection
    
    func startBridgeConnectionWithPermissionCheck() {
        guard let bridge = selectedBridge else {
            print("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω –º–æ—Å—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
            return
        }
        
        print("üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏...")
        
        if #available(iOS 14.0, *) {
            let checker = LocalNetworkPermissionChecker()
            Task {
                do {
                    let hasPermission = try await checker.requestAuthorization()
                    await MainActor.run {
                        if hasPermission {
                            print("‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –ø–æ–ª—É—á–µ–Ω–æ")
                            self.proceedWithConnection(bridge: bridge)
                        } else {
                            print("üö´ –ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏")
                            self.showLocalNetworkAlert = true
                        }
                    }
                } catch {
                    await MainActor.run {
                        print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: \(error)")
                        self.showLocalNetworkAlert = true
                    }
                }
            }
        } else {
            proceedWithConnection(bridge: bridge)
        }
    }
    
    private func proceedWithConnection(bridge: Bridge) {
        print("üîó –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–æ—Å—Ç—É: \(bridge.id) at \(bridge.internalipaddress)")
        currentStep = .linkButton
        showLinkButtonAlert = true
        
        appViewModel.connectToBridge(bridge)
        
        linkButtonTimer = Timer.scheduledTimer(withTimeInterval: 2.0, repeats: true) { [weak self] _ in
            self?.attemptCreateUserImproved()
        }
    }
}

/*
 –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ö –§–ê–ô–õ–£ OnboardingViewModel+PermissionCheck.swift
 
 –û–ø–∏—Å–∞–Ω–∏–µ:
 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.
 
 –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
 - startBridgeConnectionWithPermissionCheck() - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
 - proceedWithConnection() - –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
 
 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 viewModel.startBridgeConnectionWithPermissionCheck()
 
 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
 - LocalNetworkPermissionChecker –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
 - iOS 14.0+ –¥–ª—è async/await
 */
